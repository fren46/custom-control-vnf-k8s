import os
import subprocess

import pytest

from krules_py.krules_cli import get_config, DEFAULT_RS_TEMPLATE_PATH_KEY, PROJECT_SECTION, PROJECT_CONF_DIR,\
    PROJECT_CONF_FILE_NAME
from tests.utils import recursive_imports_check


@pytest.mark.parametrize("template_path,set_default", [("test_template", False), ("test_template", True)])
def test_create(template_path, set_default, tmpdir):
    os.chdir(tmpdir)
    subprocess.check_output(['krules-py', 'project', 'init', ".",
                             "--name", "test-project",
                             "--namespace", "test-ns",
                             "--docker-registry", "localhost:5000"
                                ])

    if set_default:
        subprocess.check_output(['krules-py', 'gen-rs-template', template_path])
    else:
        subprocess.check_output(['krules-py', 'gen-rs-template', template_path, "--set-default"])
        config = get_config(os.path.join(tmpdir, PROJECT_CONF_DIR, PROJECT_CONF_FILE_NAME))
        assert config[PROJECT_SECTION][DEFAULT_RS_TEMPLATE_PATH_KEY] == template_path

        subprocess.check_output(['krules-py', 'gen-rs-template', "--unset-default"])
        config = get_config(os.path.join(tmpdir, PROJECT_CONF_DIR, PROJECT_CONF_FILE_NAME))
        assert DEFAULT_RS_TEMPLATE_PATH_KEY not in config[PROJECT_SECTION]
    recursive_imports_check("ruleset_tmpl", template_path)
